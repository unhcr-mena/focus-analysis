---
output: 
  word_document: 
    fig_caption: yes
    fig_width: 11
    toc: yes
    toc_depth: 2
    reference_docx: style-unhcr-portrait.docx
---

```{r ctryfilter , echo=FALSE, warning=FALSE, message=FALSE, cache=FALSE}

#ctrname <- "Jordan"
yearreport <- "2019"


```



```{r libraries, include=FALSE, cache=FALSE}

library(ggplot2)
library(ggthemes)
library(rmarkdown)
library(xtable)
library(knitr)
library(pander)  ## library to format regression output in Rmd
library(readxl)

```


```{r load-data , echo=FALSE, warning=FALSE, message=FALSE, cache=FALSE}
mainDir <- getwd()
mainDirroot <- substring(mainDir, 0 , nchar(mainDir) - 5)
## Load all required packages
source(paste0(mainDirroot,"/code/0-package.R"))


##  Loading the 3 dataset - Impact, performance, budget
focus.impact <- read.csv(paste0(mainDirroot,"/data/impact.csv"))
## Subset for the country
focus1.impact <- focus.impact[focus.impact$operationName == ctrname, ]
source(paste0(mainDirroot,"/code/timeindic.R"))

focus.budget <- read.csv(paste0(mainDirroot,"/data/budget.csv"))
focus1.budget <- focus.budget[focus.budget$operationName == ctrname, ]

framework <- read_excel(paste0(mainDirroot,"/config/UNHCR-Result-Based-Management.xlsx"), sheet = 1) 
#names(framework)
framework <- framework[ !(is.na(framework$Indicator)) ,  ]
framework <- framework[ !(framework$dup2 %in% c('dup')) ,  ]
 # names(framework)

focus.narrative <- read.csv(paste0(mainDirroot,"/data/narrative.csv"))
focus1.narrative <- focus.narrative[focus.narrative$operationName == ctrname, ]
focus1.narrative$ppggoal <- paste(focus1.narrative$Population.Group, focus1.narrative$goal, sep = " - ")

## Number of ppggoal
focus1.impact$ppggoalsit <- paste(focus1.impact$Population.Group, focus1.impact$Goal, focus1.impact$SituationName, sep = " - ")

## Add order in focus 
focus1.budget$subtype.obj <- factor( focus1.budget$subtype.obj, levels =  c("Registration" ,"RSD" , "Resettlement" ,  "ChildProtection" , "SGBV", "Education", "Legal", "Mixed migration", "Statelessness", "Community Services", "Community Based Protection",
"Communication", "ProtCoordination", "NFI-cash", "Health", "Food", "Shelter", "WASH", "Supply", "CCCM", "Energy", "Environment",
"Management", "ExtRel", "Coordination")) 

ppg.ctr <- as.character(unique(focus1.impact[focus1.impact$planningPeriod == 2019, c("Population.Group")]))

ppggoalsit1 <- as.character(unique(focus1.impact[focus1.impact$planningPeriod == 2019, c("ppggoalsit")]))
ppggoalsit <- length(unique(focus1.impact[focus1.impact$planningPeriod == 2019, c("ppggoalsit")]))

## Extracting last refresh date

#names(focus1.impact)

lastRefreshedate <- as.character(unique(focus1.budget[focus1.budget$planningPeriod == 2019, c("lastRefreshed")]))

Objectives.2019 <- length(unique(focus1.impact[focus1.impact$planningPeriod == 2019, c("Objective")]))
Objectives.2018 <- length(unique(focus1.impact[focus1.impact$planningPeriod == 2018, c("Objective")]))
Objectives.2017 <- length(unique(focus1.impact[focus1.impact$planningPeriod == 2017, c("Objective")]))

impindic.2019 <- length(unique(focus1.impact[focus1.impact$planningPeriod == 2019, c("rid")]))
impindic.2018 <- length(unique(focus1.impact[focus1.impact$planningPeriod == 2018, c("rid")]))
impindic.2017 <- length(unique(focus1.impact[focus1.impact$planningPeriod == 2017, c("rid")]))


ol.budget.2019 <- format(sum(focus1.budget[focus1.budget$scenario == "Operating Level" & focus1.impact$planningPeriod == 2019, c("amount")]),
                        digits = 2, decimal.mark = ".",  big.mark = ",", scientific = FALSE)

aol.budget.2019 <- format( sum(focus1.budget[focus1.budget$scenario == "Above Operating Level" & focus1.impact$planningPeriod == 2019, c("amount")]),
                         digits = 2, decimal.mark = ".",  big.mark = ",", scientific = FALSE)


ol.budget.2018 <- format( sum(focus1.budget[focus1.budget$scenario == "Operating Level" & focus1.impact$planningPeriod == 2019,c("amount")])
                         - sum(focus1.budget[focus1.budget$scenario == "Operating Level" & focus1.impact$planningPeriod == 2018, c("amount")]),
                          digits = 2, decimal.mark = ".",  big.mark = ",", scientific = FALSE)

aol.budget.2018 <- format(sum(focus1.budget[focus1.budget$scenario == "Above Operating Level" & focus1.impact$planningPeriod == 2019,c("amount")])
                         - sum(focus1.budget[focus1.budget$scenario == "Above Operating Level" & focus1.impact$planningPeriod == 2018, c("amount")]),
                          digits = 2, decimal.mark = ".",  big.mark = ",", scientific = FALSE)

```



---
title: "Annual Review of `r ctrname` Country Operation Plan- `r yearreport`"
author: "MENA office of the Director"
date: "Based on data entered on Focus on the `r lastRefreshedate`"
---

*** 

# Introduction 

This reports provides an high level review of  `r ctrname` country operation programme. It brings together longitudinal information both in terms of narratives, budget & impact indicators. In order to faciliate the consultation, information is grouped by area of expertise.

This plan includes: 

 *  __`r ppggoalsit`__ Population Planning Group(s) associated with Goal & situation,

 *  __`r Objectives.2019`__ Objectives (`r Objectives.2018`% change compared with 2018), 

 *  __`r impindic.2019`__ Impact indicators (`r impindic.2018` % change compared 2018)

The report is extracting information from Focus in order to review selected objectives within each sector/functional areas:

##	Comparison of Narrative: 
 
   *  2016 "Results and Impact - Results and Impact"" 
   *  2017 "Results and Impact - Results and Impact" 
   *  2018 "Problem/Objective - Prioritized Response" 
   *  2019 "Problem Assessment and Comprehensive Response" 

 
##	Budget evolution from 2016 to 2019 at objective level â€“ stacked by scenario.
 
This plan present an "operating level" budget of  __`r ol.budget.2019`USD__  (difference of `r ol.budget.2018` USD with 2018) and an "above operating level" budget of __`r aol.budget.2019` USD__ (difference of `r aol.budget.2018` USD with 2018)


Globally the budget evolution per area of expertise is:

```{r budgettopic , echo=FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.width=8, fig.height=9}
 
ggplot(focus1.budget[focus1.budget$planningPeriod %in% c("2016","2017","2018","2019") &
                       focus1.budget$subtype.obj %in% c("Registration" ,"RSD" , "Resettlement" ,  "ChildProtection" ,"Education", "SGBV", "Legal", "Mixed migration", "Statelessness", "Community Services", "Community Based Protection") , ], aes(x =  planningPeriod , fill = scenario )) + 
            geom_bar(aes(y = amount), stat = "identity") +
            facet_wrap(~ subtype.obj, ncol = 1) +
           # ggtitle(paste0("Output: ", indicplot)) +
            ggtitle("Budget per scenario & year (in USD for Operating level only",  
                  subtitle = "Breakdown per functional area") +
            coord_flip() +
            xlab("") + ylab("") +
            scale_y_continuous(labels = format_si()) +
            theme_economist_white() +
            theme(legend.key = element_blank(),
                  plot.title = element_text(face = "bold", size = 12),
                  axis.text = element_text(size = 7, face = "plain"),
                  #legend.title=element_blank(),
                  legend.box = "horizontal")

```

```{r budgettopic2 , echo=FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.width=8, fig.height=9}
 
ggplot(focus1.budget[focus1.budget$planningPeriod %in% c("2016","2017","2018","2019") &
                       focus1.budget$subtype.obj %in% c("Communication", "ProtCoordination", "NFI-cash", "Health", "Food", "Shelter", "WASH", "Supply", "CCCM", "Energy", "Environment",
"Management", "ExtRel", "Coordination" ) , ], aes(x =  planningPeriod , fill = scenario )) + 
            geom_bar(aes(y = amount), stat = "identity") +
            facet_wrap(~ subtype.obj, ncol = 1) +
           # ggtitle(paste0("Output: ", indicplot)) +
            ggtitle("Budget per scenario & year (in USD for Operating level only",  
                  subtitle = "Breakdown per functional area") +
            coord_flip() +
            xlab("") + ylab("") +
            scale_y_continuous(labels = format_si()) +
            theme_economist_white() +
            theme(legend.key = element_blank(),
                  plot.title = element_text(face = "bold", size = 12),
                  axis.text = element_text(size = 7, face = "plain"),
                  #legend.title=element_blank(),
                  legend.box = "horizontal")

```

##	Impact indicators 

Impact indicators from 2016 year end till 2019 baseline are presented. A notification is inserted in the title of the chart if the indicator is among Global Strategic Priorities (GSP).

Impact indicator charts can be interpreted as follows:

![__Diagram:__ Gap, progress & achievement](gap.png)

It's expected that year-end from year __'n'__ equals the baseline form year __'n+1'__. Any drastic change in the values of the indicator should be explained in the narrative for the objective.

*** 
# Refugee Registration

```{r Registration, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "Registration"
#list.files()
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Refugee Status Determination (RSD)

```{r RSD, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "RSD"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Resettlement

```{r Resettlement, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "Resettlement"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Child Protection

```{r ChildProtection, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "ChildProtection"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Sexual and other forms of gender-based violence (SGBV)

```{r SGBV, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "SGBV"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Education

```{r Education, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "Education"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Legal issues

```{r Legal, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "Legal"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Mixed Migration

```{r Mixedmigration, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "Mixed migration"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Statelessness

```{r Statelessness, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "Statelessness"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Community Services

```{r CommunityServices, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "Community Services"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Community Based Protection

```{r CBP, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "Community Based Protection"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Communication

```{r Communication, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "Communication"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Protection Coordination

```{r ProtCoordination, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "ProtCoordination"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Non Food Item (NFI) & Cash Based Intervention

```{r NFI-cash, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "NFI-cash"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Health

```{r Health, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "Health"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Food Security & Nutrition

```{r , echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "Food"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Shelter

```{r Shelter, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "Shelter"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# WASH

```{r WASH, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "WASH"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Supply


```{r Supply, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "Supply"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Camp Coordination and Camp Management (CCCM)

```{r CCCM, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "CCCM"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Energy

```{r Energy, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "Energy"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Environment

```{r Environment, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "Environment"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Management

```{r Management, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "Management"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# External Relations

```{r ExtRel, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "ExtRel"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

*** 
# Response Coordination

```{r Coordination, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=6}
this.subtype <- "Coordination"
source(paste0(mainDirroot,"/code/obj_review.R"))
```

***
END OF REPORT
